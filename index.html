<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ã‚¹ã‚¿ãƒ³ãƒ—ãƒ©ãƒªãƒ¼å …ç‰¢ç‰ˆ</title>
<style>
  body { font-family: sans-serif; text-align: center; padding: 20px; background-color: #f0f8ff; }
  .card { background: white; padding: 20px; margin: 10px auto; border-radius: 10px; box-shadow: 0 4px 8px rgba(0,0,0,0.1); max-width: 400px; }
  h1 { color: #333; }
  button { font-size: 1.2em; padding: 10px 20px; background-color: #ff6347; color: white; border: none; border-radius: 5px; cursor: pointer; }
  button:disabled { background-color: #ccc; cursor: not-allowed; }
  
  #status { margin-top: 20px; font-weight: bold; min-height: 1.5em; line-height: 1.6; }
  .error-msg { color: red; font-size: 0.9em; margin-top: 10px; background: #ffe6e6; padding: 10px; border-radius: 5px; }
  
  /* è·é›¢è¡¨ç¤º */
  .distance-info { color: #007bff; font-size: 1.1em; margin-top: 5px; }
  .success-msg { color: red; font-size: 1.2em; font-weight: bold; animation: pop 0.5s ease; }
  @keyframes pop { 0% { transform: scale(0.8); } 50% { transform: scale(1.2); } 100% { transform: scale(1.0); } }
  
  .revision { font-size: 10px; color: #aaa; margin-top: 20px; }
</style>
</head>
<body>

<div class="card">
  <h1>ğŸ—ºï¸ éŸ³å£°ã‚¹ã‚¿ãƒ³ãƒ—ãƒ©ãƒªãƒ¼</h1>
  <p>ã‚ã¨ä½•mã§åˆ°ç€ã™ã‚‹ã‹<br>ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ã—ã¾ã™</p>
  
  <button id="btnStart" onclick="startTour()">ãƒ„ã‚¢ãƒ¼ã‚’é–‹å§‹</button>
  
  <div id="status">ãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ã¦ãã ã•ã„</div>
  <div id="debugLog"></div>
</div>

<div class="card">
  <h3>ã‚¹ã‚¿ãƒ³ãƒ—ã‚«ãƒ¼ãƒ‰</h3>
  <ul id="spotList" class="spot-list">
    </ul>
  <p class="revision">Rev. 6 (Robust GPS)</p>
</div>

<script>
// â˜…éŸ³å£°ãƒ•ã‚¡ã‚¤ãƒ«ã®æº–å‚™â˜…
const soundEffect = new Audio('spot1.mp3');

// â˜…è¨­å®šã‚¨ãƒªã‚¢â˜…
const spots = [
  // 1. æŒ‡å®šã®ãƒ†ã‚¹ãƒˆåœ°ç‚¹
  { name: "â‘  ãƒ†ã‚¹ãƒˆåœ°ç‚¹", lat: 34.5525876, lng: 134.9955754, cleared: false },
  
  // 2. åŒ—ã«ã‚ã‚‹æ¶ç©ºã®ã‚¹ãƒãƒƒãƒˆ
  { name: "â‘¡ åŒ—ã®ã‚¹ãƒãƒƒãƒˆ", lat: 34.8344, lng: 134.6934, cleared: false } 
];

const RADIUS = 5000; // åŠå¾„50m
let watchId = null; // GPSç›£è¦–ID

function startTour() {
  if (!navigator.geolocation) {
    alert("ã“ã®ç«¯æœ«ã¯GPSéå¯¾å¿œã§ã™");
    return;
  }

  // ãƒœã‚¿ãƒ³ã‚’ä¸€æ™‚çš„ã«ç„¡åŠ¹åŒ–
  const btn = document.getElementById("btnStart");
  btn.disabled = true;
  btn.innerText = "èµ·å‹•ä¸­...";

  // éŸ³å£°ã‚¢ãƒ³ãƒ­ãƒƒã‚¯
  soundEffect.play().then(() => {
      soundEffect.pause();
      soundEffect.currentTime = 0;
  }).catch(e => {
      // ã‚¨ãƒ©ãƒ¼ã§ã‚‚æ­¢ã¾ã‚‰ãªã„ã‚ˆã†ã«ã™ã‚‹
      console.log("Audio unlock failed", e);
  });

  document.getElementById("status").innerText = "ğŸ“¡ GPSä¿¡å·ã‚’æ¢ã—ã¦ã„ã¾ã™...";
  document.getElementById("debugLog").innerHTML = ""; // ã‚¨ãƒ©ãƒ¼æ¶ˆå»

  // ä»¥å‰ã®ç›£è¦–ãŒã‚ã‚Œã°ã‚¯ãƒªã‚¢
  if (watchId !== null) {
    navigator.geolocation.clearWatch(watchId);
  }

  // GPSé–‹å§‹ï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ã‚’ç·©ã‚ã¦ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆã—ã«ããè¨­å®šï¼‰
  watchId = navigator.geolocation.watchPosition(success, error, {
    enableHighAccuracy: true, // é«˜ç²¾åº¦
    timeout: 30000,           // â˜…å¤‰æ›´ï¼š30ç§’å¾…ã¤ï¼ˆä»¥å‰ã¯10ç§’ï¼‰
    maximumAge: 5000          // â˜…å¤‰æ›´ï¼š5ç§’ä»¥å†…ã®å¤ã„ãƒ‡ãƒ¼ã‚¿ã‚‚è¨±å®¹
  });
  
  updateList();
}

function success(position) {
  // æˆåŠŸã—ãŸã‚‰ãƒœã‚¿ãƒ³ã‚’ã€Œå†èµ·å‹•ã€è¡¨è¨˜ã«æˆ»ã—ã¦æŠ¼ã›ã‚‹ã‚ˆã†ã«ã™ã‚‹
  const btn = document.getElementById("btnStart");
  btn.innerText = "GPSå†èµ·å‹•";
  btn.disabled = false;

  const currentLat = position.coords.latitude;
  const currentLng = position.coords.longitude;
  const accuracy = position.coords.accuracy; // èª¤å·®(m)

  // 1. å„ã‚¹ãƒãƒƒãƒˆã¨ã®è·é›¢è¨ˆç®—
  let nearestDist = Infinity;
  let nearestName = "";
  let isJustCleared = false;

  spots.forEach((spot) => {
    if (spot.cleared) return;

    const dist = getDistance(currentLat, currentLng, spot.lat, spot.lng);
    const distToArea = dist - RADIUS;

    if (distToArea <= 0) {
      spot.cleared = true;
      isJustCleared = true;
      
      soundEffect.currentTime = 0;
      soundEffect.play().catch(e => console.log(e));

      document.getElementById("status").innerHTML = 
        `<div class='success-msg'>ğŸ‰ ${spot.name}<br>ã‚¹ã‚¿ãƒ³ãƒ—ã‚²ãƒƒãƒˆï¼</div>`;
      
      updateList();
    } else {
      if (distToArea < nearestDist) {
        nearestDist = distToArea;
        nearestName = spot.name;
      }
    }
  });

  // 2. ç”»é¢è¡¨ç¤º
  if (!isJustCleared) {
    let statusHTML = `ğŸ“ ç¾åœ¨åœ° (èª¤å·®Â±${Math.floor(accuracy)}m)<br><span style="font-size:0.8em">${currentLat.toFixed(5)}, ${currentLng.toFixed(5)}</span>`;
    
    if (nearestName !== "") {
      statusHTML += `<div class="distance-info">ğŸƒâ€â™‚ï¸ æ¬¡ã® ${nearestName} ã¾ã§<br>ã‚ã¨ <b>${Math.ceil(nearestDist)}m</b></div>`;
    } else {
      statusHTML += `<div class="distance-info">ğŸ‰ å…¨ã‚¹ãƒãƒƒãƒˆã‚³ãƒ³ãƒ—ãƒªãƒ¼ãƒˆï¼</div>`;
    }
    
    document.getElementById("status").innerHTML = statusHTML;
  }
}

function error(err) {
  const btn = document.getElementById("btnStart");
  btn.innerText = "å†è©¦è¡Œã™ã‚‹";
  btn.disabled = false;

  let msg = "";
  switch(err.code) {
    case 1: msg = "ä½ç½®æƒ…å ±ã®åˆ©ç”¨ãŒè¨±å¯ã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚\nãƒ–ãƒ©ã‚¦ã‚¶ã®è¨­å®šã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚"; break;
    case 2: msg = "é›»æ³¢çŠ¶æ³ãŒæ‚ªãã€ä½ç½®ãŒç‰¹å®šã§ãã¾ã›ã‚“ã§ã—ãŸã€‚\nçª“éš›ã‚„å±‹å¤–ã§è©¦ã—ã¦ãã ã•ã„ã€‚"; break;
    case 3: msg = "ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆã—ã¾ã—ãŸã€‚\nï¼ˆåˆ¶é™æ™‚é–“å†…ã«ä½ç½®ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸï¼‰"; break;
    default: msg = "ä¸æ˜ãªã‚¨ãƒ©ãƒ¼: " + err.message;
  }
  
  document.getElementById("status").innerText = "âš ï¸ ã‚¨ãƒ©ãƒ¼ç™ºç”Ÿ";
  document.getElementById("debugLog").innerHTML = `<div class="error-msg">${msg}</div>`;
}

function updateList() {
  const list = document.getElementById("spotList");
  list.innerHTML = "";
  spots.forEach(spot => {
    const li = document.createElement("li");
    li.className = "spot-item " + (spot.cleared ? "cleared" : "");
    li.innerText = spot.cleared ? `âœ… ${spot.name}` : `â¬œ ${spot.name}`;
    list.appendChild(li);
  });
}

function getDistance(lat1, lon1, lat2, lon2) {
  const R = 6371000;
  const dLat = (lat2 - lat1) * Math.PI / 180;
  const dLon = (lon2 - lon1) * Math.PI / 180;
  const a = Math.sin(dLat / 2) * Math.sin(dLat / 2) +
            Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
            Math.sin(dLon / 2) * Math.sin(dLon / 2);
  const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
  return R * c;
}
</script>

</body>
</html>
