<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ã‚¹ã‚¿ãƒ³ãƒ—ãƒ©ãƒªãƒ¼åºƒåŸŸç‰ˆ</title>
<style>
  body { font-family: sans-serif; text-align: center; padding: 20px; background-color: #f0f8ff; }
  .card { background: white; padding: 20px; margin: 10px auto; border-radius: 10px; box-shadow: 0 4px 8px rgba(0,0,0,0.1); max-width: 400px; }
  h1 { color: #333; }
  button { font-size: 1.2em; padding: 10px 20px; background-color: #ff6347; color: white; border: none; border-radius: 5px; cursor: pointer; }
  button:disabled { background-color: #ccc; cursor: not-allowed; }
  
  #status { margin-top: 20px; font-weight: bold; min-height: 1.5em; line-height: 1.6; }
  .error-msg { color: red; font-size: 0.9em; margin-top: 10px; background: #ffe6e6; padding: 10px; border-radius: 5px; }
  
  /* è·é›¢è¡¨ç¤º */
  .distance-info { color: #007bff; font-size: 1.1em; margin-top: 5px; }
  .success-msg { color: red; font-size: 1.2em; font-weight: bold; animation: pop 0.5s ease; }
  @keyframes pop { 0% { transform: scale(0.8); } 50% { transform: scale(1.2); } 100% { transform: scale(1.0); } }
  
  .revision { font-size: 10px; color: #aaa; margin-top: 20px; }
</style>
</head>
<body>

<div class="card">
  <h1>ğŸ—ºï¸ éŸ³å£°ã‚¹ã‚¿ãƒ³ãƒ—ãƒ©ãƒªãƒ¼</h1>
  <p>åŠå¾„5kmä»¥å†…ã§åå¿œã—ã¾ã™<br>ï¼ˆãƒ†ã‚¹ãƒˆãƒ¢ãƒ¼ãƒ‰ï¼‰</p>
  
  <button id="btnStart" onclick="startTour()">ãƒ„ã‚¢ãƒ¼ã‚’é–‹å§‹</button>
  
  <div id="status">ãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ã¦ãã ã•ã„</div>
  <div id="debugLog"></div>
</div>

<div class="card">
  <h3>ã‚¹ã‚¿ãƒ³ãƒ—ã‚«ãƒ¼ãƒ‰</h3>
  <ul id="spotList" class="spot-list">
    </ul>
  <p class="revision">Rev. 7 (Radius 5000m)</p>
</div>

<script>
// â˜…éŸ³å£°ãƒ•ã‚¡ã‚¤ãƒ«ã®æº–å‚™â˜…
const soundEffect = new Audio('spot1.mp3');

// â˜…è¨­å®šã‚¨ãƒªã‚¢â˜…
const spots = [
  // 1. æŒ‡å®šã®ãƒ†ã‚¹ãƒˆåœ°ç‚¹
  { name: "â‘  ãƒ†ã‚¹ãƒˆåœ°ç‚¹", lat: 34.8397, lng: 134.6776, cleared: false },
  
  // 2. åŒ—ã«ã‚ã‚‹æ¶ç©ºã®ã‚¹ãƒãƒƒãƒˆ
  { name: "â‘¡ åŒ—ã®ã‚¹ãƒãƒƒãƒˆ", lat: 34.8344, lng: 134.6934, cleared: false } 
];

// â˜…åˆ¤å®šåŠå¾„ã‚’5000mï¼ˆ5kmï¼‰ã«å¤‰æ›´ã—ã¾ã—ãŸâ˜…
const RADIUS = 5000; 

let watchId = null; 

function startTour() {
  if (!navigator.geolocation) {
    alert("ã“ã®ç«¯æœ«ã¯GPSéå¯¾å¿œã§ã™");
    return;
  }

  const btn = document.getElementById("btnStart");
  btn.disabled = true;
  btn.innerText = "èµ·å‹•ä¸­...";

  // éŸ³å£°ã‚¢ãƒ³ãƒ­ãƒƒã‚¯
  soundEffect.play().then(() => {
      soundEffect.pause();
      soundEffect.currentTime = 0;
  }).catch(e => {
      console.log("Audio unlock failed", e);
  });

  document.getElementById("status").innerText = "ğŸ“¡ GPSä¿¡å·ã‚’æ¢ã—ã¦ã„ã¾ã™...";
  document.getElementById("debugLog").innerHTML = "";

  if (watchId !== null) {
    navigator.geolocation.clearWatch(watchId);
  }

  watchId = navigator.geolocation.watchPosition(success, error, {
    enableHighAccuracy: true,
    timeout: 30000,           
    maximumAge: 5000          
  });
  
  updateList();
}

function success(position) {
  const btn = document.getElementById("btnStart");
  btn.innerText = "GPSå†èµ·å‹•";
  btn.disabled = false;

  const currentLat = position.coords.latitude;
  const currentLng = position.coords.longitude;
  const accuracy = position.coords.accuracy;

  let nearestDist = Infinity;
  let nearestName = "";
  let isJustCleared = false;

  spots.forEach((spot) => {
    if (spot.cleared) return;

    const dist = getDistance(currentLat, currentLng, spot.lat, spot.lng);
    const distToArea = dist - RADIUS; // æ®‹ã‚Šè·é›¢è¨ˆç®—
